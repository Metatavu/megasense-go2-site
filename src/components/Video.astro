---
import { Image } from "astro:assets";
import pauseIcon from "@images/pause-icon.svg";
import playIcon from "@images/play-icon.svg";
import muteIcon from "@images/mute-icon.svg";
import iconVolumeOff from "@images/icon-volume-off.svg";
import downArrow from "@images/down-arrow-icon-grey.svg";
import GO2Explainer from "@video/GO2-Explainer.mp4";

---

<!-- TODO: Video styling to finalize -->
<figure class="w-screen relative flex items-center justify-center bg-">
  <!-- Muted attribute required for autoplay to work in chrome -->
  <video
    id="video"
    controls
    preload="metadata"
    poster="/src/images/video-poster.png"
    autoplay
    muted
    class="h-[75vh]"
  >
    <!-- <source src={GO2Explainer} type="video/mp4" /> -->
    <track
      label="English"
      kind="subtitles"
      srclang="en"
      src="/src/video/GO2-Explainer-subtitles.vtt"
      default
    />
  </video>
  <ul
    id="video-controls"
    class="absolute -bottom-5 flex w-screen lg:w-1/2 justify-around"
  >
    <li class="flex items-center">
      <button id="playpause" type="button">
        <Image id="pause-icon" src={pauseIcon} alt="pause icon" />
        <!-- TODO: Fix icon color and sizing? -->
        <Image id="play-icon" src={playIcon} class="hidden" alt="play icon" />
      </button>
    </li>
    <li class="flex items-center">
      <progress
        id="progress"
        value="0"
        class="h-1 [&::-webkit-progress-bar]:bg-white [&::-webkit-progress-value]:bg-go2-blue [&::-moz-progress-bar]:bg-go2-blue sm:w-[400px] md:w-[550px] xl:w-[650px] 2lx:w-[750px]"
      >
        <span id="progress-bar"></span>
      </progress>
    </li>
    <li class="flex items-center">
      <button id="mute" type="button">
        <Image id="mute-icon" src={muteIcon} class="hidden" alt="mute icon" />
        <!-- TODO: Fix icon color and sizing? -->
        <Image id="icon-volume-off" src={iconVolumeOff} alt="volume off icon" />
      </button>
    </li>
  </ul>
  <div class="absolute -bottom-16 flex w-screen justify-around">
    <a id="scroll-down-button" href="#features">
      <Image src={downArrow} alt="down arrow icon" />
    </a>
  </div>
</figure>


<script>
  const supportsVideo = !!document.createElement("video").canPlayType;
  if (supportsVideo) {
    const video = document.getElementById("video") as HTMLVideoElement;

    video.controls = false;

    const playpause = document.getElementById("playpause") as HTMLElement;
    const progress = document.getElementById("progress") as HTMLProgressElement;
    const progressBar = document.getElementById("progress-bar") as HTMLProgressElement;
    const mute = document.getElementById("mute") as HTMLElement;
    const pauseIcon = document.getElementById("pause-icon") as HTMLElement;
    const playIconHidden = document.getElementById("play-icon") as HTMLElement;
    const muteIconHidden = document.getElementById("mute-icon") as HTMLElement;
    const volumeOffIcon = document.getElementById("icon-volume-off") as HTMLElement;
    const scrollDownButton = document.getElementById("scroll-down-button") as HTMLElement;

    const playIcon = playIconHidden.cloneNode(true) as HTMLElement;
    const muteIcon = muteIconHidden.cloneNode(true) as HTMLElement;
    playIcon.classList.toggle("hidden");
    muteIcon.classList.toggle("hidden");

    playpause.addEventListener("click", () => {
      if (video.paused || video.ended) {
        playpause.innerHTML = "";
        playpause.appendChild(pauseIcon);
        video.play();
      } else {
        video.pause();
        playpause.innerHTML = "";
        playpause.appendChild(playIcon);
      }
    });

    video.addEventListener("loadedmetadata", () => {
      progress.setAttribute("max", video.duration.toString());
    });

    video.addEventListener("timeupdate", () => {
      progress.value = video.currentTime;
      progressBar.style.width = `${Math.floor(
        (video.currentTime * 100) / video.duration,
      )}%`;
    });

    video.addEventListener("timeupdate", () => {
      if (!progress.getAttribute("max"))
        progress.setAttribute("max", video.duration.toString());
      progress.value = video.currentTime;
      progressBar.style.width = `${Math.floor(
        (video.currentTime * 100) / video.duration,
      )}%`;
    });

    mute.addEventListener("click", () => {
      if (video.muted) {
        video.muted = false;
        mute.innerHTML = "";
        mute.appendChild(muteIcon);
      } else {
        video.muted = true;
        mute.innerHTML = "";
        mute.appendChild(volumeOffIcon);
      }
    });

    scrollDownButton.addEventListener("click", () => {
      const targetElement = document.getElementById('features');
      if (targetElement) {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block:"start",
        });
      }
    })
  }

</script>